<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Usage</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SOFUN</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="usage.html">Usage</a>
</li>
<li>
  <a href="pmodel.html">P-model</a>
</li>
<li>
  <a href="cnmodel.html">CN-model</a>
</li>
<li>
  <a href="inputoutput.html">Input / Output</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Usage</h1>

</div>


<p>SOFUN is designed in a modular fashion that allows for alternative process representations and levels of integration (see figure below) to be implemented within the same modelling framework. Its levels of integration are described below.</p>
<div class="figure">
<img src="fig/sofun_modularframework.png" />

</div>
<p><em>Above: Illustration of the modular hierarchy of integration. SOFUN can either be run mode <strong>SPLASH</strong> (simulating evapotranspiration and the soil water balance, given precipitation), mode <strong>P-model</strong> (simulating ci:ca, light use efficiency and GPP, globally, given temperature, PAR, VPD, and CO<span class="math inline">\(_2\)</span>), mode <strong>C-model</strong> (simulating the cycling of C in a grassland with fixed allocation), or mode <strong>CN-model</strong> (simulating the cycling of C and N in a grassland with flexible allocation). The P-model setup requires fAPAR to be prescribed, while the C-model and CN-model setups simulate LAI and fAPAR internally.</em></p>
<div id="levels-of-integration" class="section level2">
<h2>Levels of integration</h2>
<p>SOFUN can be executed at different levels of integration.</p>
<div id="splash" class="section level3">
<h3>SPLASH</h3>
<p>This setup simulates potential evapotranspiration (Priestly-Taylor equation) and the soil water balance (bucket model), given precipitation and cloud cover as inputs. The model is described in <a href="https://www.geosci-model-dev.net/10/689/2017/">Davis et al. (2107)</a>. The photosyntetically active radiation calculated by SPLASH may be used to drive the P-model. Soil moisture calculated by SPLASH may be used for an empirical estimate of the reduction in light use efficiency in the P-model.</p>
<p>Compile and execute the model by</p>
<pre class="bash"><code>make splash
echo example_splash_sitescale | ./runsplash</code></pre>
<p>An alternative implementation of the soil water balance follows the Simple Water Balance Model by <a href="http://journals.ametsoc.org/doi/abs/10.1175/JHM-D-12-099.1">Orth et al. (2013)</a>, where runoff is generated before 100% water holding capacity is reached. This version can be compiled and executed by</p>
<pre class="bash"><code>make swbm
echo example_swbm_sitescale | ./runswbm</code></pre>
</div>
<div id="p-model" class="section level3">
<h3>P-model</h3>
<p>This setup implements the P-model descrbed by <a href="http://onlinelibrary.wiley.com/doi/10.1111/ele.12211/abstract">Prentice et al. (2013)</a> and <a href="https://www.nature.com/articles/s41477-017-0006-8?error=cookies_not_supported&amp;code=878efd7b-d536-4a36-8b65-e24b054ba011">Wang Han et al. (2017)</a>. See also <a href="https://stineb.github.io/pmodel.html">P-model</a>. In combination with prescribed rates of absorbed photosynthetically active radiation, the P-model can be applied as a light use efficiency model for simulating ecosystem-level gross primary productivity.</p>
<p>Compile and execute for site-scale simulations by</p>
<pre class="bash"><code>make pmodel
echo example_sitescale | ./runpmodel</code></pre>
<p>Compile and execute for global simulations by</p>
<pre class="bash"><code>make gpmodel
echo example_global | ./rungpmodel</code></pre>
</div>
<div id="cn-model" class="section level3">
<h3>CN-model</h3>
<p>This implements a fully integrated model for the cycling of carbon and nitrogen in a grassland (see <a href="https://stineb.github.io/cnmodel.html">here</a>). Currently only implemented for site-scale simulations.</p>
<pre class="bash"><code>make cnmodel
echo example_sitescale | ./runcnmodel</code></pre>
</div>
<div id="c-model" class="section level3">
<h3>C-model</h3>
<p>This implements the same components as the CN-model, but assumes a fixed allocation (root-to-shoot ratio) and does not close the N budget. It mimics a C-only model.</p>
<pre class="bash"><code>make cmodel
echo example_sitescale | ./runcmodel</code></pre>
</div>
</div>
<div id="setup-for-site-level-simulations" class="section level2">
<h2>Setup for site-level simulations</h2>
<p>Below, the setup - from processing input data to running simulations - for site-level simulations for all FLUXNET 2015 Tier 1 sites is given as an example.</p>
<div id="summary-of-setup-steps-for-site-level-simulations" class="section level3">
<h3>Summary of setup steps for site-level simulations:</h3>
<ol style="list-style-type: decimal">
<li>Get fAPAR forcing data (for P-model only)</li>
<li>Get climate forcing data</li>
<li>Get CO2 forcing data</li>
<li>Get site and simulation parameter files</li>
<li>Run SOFUN</li>
</ol>
<p>Model forcing data is available on Imperial HPC’s CX1 (<code>work/bstocker/data</code>) or can be downloaded or read from files using R scripts in repository <a href="https://bitbucket.org/labprentice/getin">getin</a>. All described below.</p>
<p>Here, we’re preparing site-specific model forcing data. Each <em>simulation suite</em> (collection of sites that belong to a certain dataset, measurement campaign, or similar), has one meta information file which specifies (at minimum) the following information:</p>
<ul>
<li><code>mysitename</code>: site ID, character</li>
<li><code>lon</code>: longitude of site, decimal</li>
<li><code>lat</code>: latitude of site, decimal</li>
<li><code>year_start</code>: start year of the simulation (for which data is available)</li>
<li><code>year_end</code>: end year of the simulation (for which data is available)</li>
</ul>
<p>For certain simulation suites, meta information files are available from the repository <a href="https://bitbucket.org/labprentice/getin">getin</a>: <code>getin/metafiles_&lt;simsuite&gt;/siteinfo_&lt;simsuite&gt;_sofun.csv</code>. The meta information file the “centre-piece” that is used by several scripts that loop over sites in a given simulation suite. It may also be generated by the R script in repository getin <code>prepare_paramfils_&lt;simsuite&gt;.R</code>, available in repository <a href="https://bitbucket.org/labprentice/getin">getin</a>.</p>
<p>Here, we’re using the FLUXNET 2015 dataset. Therefore, we’re setting:</p>
<pre class="r"><code>simsuite = &quot;fluxnet2015&quot;</code></pre>
<p>Forcing data is written into different subdirectories of <code>your_chosen_home/sofun/input_&lt;simsuite&gt;_sofun/</code>. Make sure this directory exists (here for simuite=<code>fluxnet2015</code>):</p>
<pre class="bash"><code>cd your_chosen_home
mkdir -p sofun/input_fluxnet2015_sofun</code></pre>
</div>
<div id="fapar-get-forcing-data" class="section level3">
<h3>1. fAPAR Get forcing data</h3>
<p>When executing the calibration on a local machine, download the data from CX1 or process new data.</p>
<div id="downloading-from-cx1" class="section level4">
<h4>Downloading from CX1</h4>
<p>Site-scale subsets from the MODIS FPAR MCD15A3H (Collection 6) data (4 days, 500 m) for all FLUXNET 2015 Tier 1 sites are available on Imperial HPC’s CX1: <code>work/bstocker/data/fapar_MODIS_FPAR_MCD15A3H_fluxnet2015_gee_subset/fapar_MODIS_FPAR_MCD15A3H_&lt;sitename&gt;_gee_subset.csv</code></p>
<p>Download the entire directory <code>fapar_MODIS_FPAR_MCD15A3H_fluxnet2015_gee_subset</code> and place it in <code>your_chosen_home/data/</code>. Do not modify the directory and file name structure from <code>your_chosen_home/data/</code> downwards. Specify the path in the header of file XXX.</p>
</div>
<div id="processing-new" class="section level4">
<h4>Processing new</h4>
<p>Downloading site-scale data from Google Earth Engine and interpolating to daily data is done using <code>gee_subset.py</code> from the repository <a href="https://github.com/stineb/gee_subset">gee_subset</a> by Koen Hufkens and <code>get_sitesubset_gee.R</code> from the repository <a href="https://bitbucket.org/labprentice/getin">getin</a>. Gapfilling and interpolation to daily values is done by filtering based on the MODIS quality flags (see <code>gapfill_modis.R</code> from the repository <a href="https://bitbucket.org/labprentice/getin">getin</a>) and applying a spline to daily values.</p>
<p><code>your_chosen_home</code> is the path where you chose to place the repositories getin and gee_subset and the <code>data</code> and <code>sofun</code> directories.</p>
<p><strong>1. Clone gee_subset</strong></p>
<p>In your shell, do:</p>
<pre class="bash"><code>cd your_chosen_home
git clone https://github.com/stineb/gee_subset </code></pre>
<p>Switch to branch <code>gee_stineb</code> by:</p>
<pre class="bash"><code>cd your_chosen_home/gee_subset
git checkout gee_stineb</code></pre>
<p>To execute <code>gee_subset.py</code>, you must have a Google Earth Enginge login and authenticate yourself. To set this up, follow steps described in <code>setup_steps.md</code>.</p>
<p><strong>2. Clone getin</strong></p>
<p>In your shell, do:</p>
<pre class="bash"><code>cd your_chosen_home
git clone https://bitbucket.org/labprentice/getin</code></pre>
<p>You must have a login on bitbucket and belong to the group ‘labprentice’ to get getin.</p>
<p><strong>3. Execute</strong></p>
<p>Change to the directory to where your local clone of the <a href="https://bitbucket.org/labprentice/getin">getin</a> repository is located. In the header of the R script <code>get_sitesubset_gee.R</code> (see <code>MANUAL SETTINGS</code>), set then manual settings by hand, for example:</p>
<pre class="r"><code>##--------------------------------------------------------------------
## MANUAL SETTINGS
##--------------------------------------------------------------------
myhome               = &quot;/alphadata01/bstocker/&quot;
simsuite             = &quot;fluxnet2015&quot;
bundle               = &quot;fapar&quot;
overwrite_raw        = FALSE
overwrite_nice       = TRUE
do_plot_interpolated = TRUE
start_date           = &quot;2000-01-01&quot;
end_date             = &quot;2017-11-27&quot;
years_out            = 1980:2017   # creating SOFUN input data for these years
##--------------------------------------------------------------------</code></pre>
<p>Then execute it in R:</p>
<pre class="r"><code>setwd(&quot;your_chosen_home/getin&quot;)
source(&quot;get_sitesubset_gee.R&quot;)</code></pre>
</div>
</div>
<div id="get-climate-forcing-data" class="section level3">
<h3>2. Get climate forcing data</h3>
<p>Climate model forcing for site-scale simulations is extracted from site-specific meteo data and/or global fields (WATCH-WFDEI and CRU TS implemented), and written to CSV files containing all days of all simulation years, as well as annual ascii text files for each year. All files are stored in a pre-defined directory structure:</p>
<ul>
<li>CSV files: <code>your_chosen_home/sofun/input_&lt;simsuite&gt;_sofun/sitedata/climate/&lt;sitename&gt;/clim_daily_&lt;sitename&gt;.csv</code></li>
<li>Annual ascii text files: <code>your_chosen_home/sofun/input_&lt;simsuite&gt;_sofun/sitedata/climate/&lt;sitename&gt;/&lt;year&gt;/d&lt;var&gt;_&lt;sitename&gt;_&lt;year&gt;.txt</code></li>
</ul>
<p><code>var</code> stands for the variable name (<code>temp</code>, <code>prec</code>, <code>vpd</code>, <code>ppfd</code>, [<code>netrad</code>]).</p>
<p>All climate data for FLUXNET 2015 simulations can be read from data distributed by the FLUXNET 2015 dataset. Download the full dataset from CX1 to your local machine (alternatively, run all the following scripts on CX1). The dataset with daily data is on CX1 under: <code>/work/bstocker/data/FLUXNET-2015_Tier1</code>. Place this directory in <code>your_chosen_home/data/</code>.</p>
<p>Processing new climate input files is done using functionality from the repository <a href="https://bitbucket.org/labprentice/getin">getin</a>. Clone this repo as described above. In <code>get_climate2.R</code>, adjust the header manually. For example:</p>
<pre class="r"><code>##--------------------------------------------------------------------
## MANUAL SETTINGS
##--------------------------------------------------------------------
myhome           = &quot;/alphadata01/bstocker/&quot;
simsuite         = &quot;fluxnet2015&quot;  
overwrite        = TRUE
overwrite_byst   = TRUE
in_ppfd          = TRUE
in_netrad        = FALSE
startyr_override = 2010
add_cru          = FALSE
add_watch        = FALSE
add_meteo        = TRUE
##--------------------------------------------------------------------</code></pre>
<p>Then execute it in R:</p>
<pre class="r"><code>setwd(&quot;your_chosen_home/getin&quot;)
source(&quot;get_climate2.R&quot;)</code></pre>
</div>
<div id="get-co2-forcing-data" class="section level3">
<h3>3. Get CO2 forcing data</h3>
<p>Execute the script that places a copy of the global CO2 time series in a separate directory for each site. Necessary like this - keeping it flexible for cases where CO2 is manipulated per site/experiment. Adjust header:</p>
<pre class="r"><code>##--------------------------------------------------------------------
## MANUAL SETTINGS
##--------------------------------------------------------------------
myhome           = &quot;/alphadata01/bstocker/&quot;
simsuite         = &quot;fluxnet2015&quot;  
##--------------------------------------------------------------------</code></pre>
<p>Then execute in R:</p>
<pre class="r"><code>setwd(&quot;your_chosen_home/getin&quot;)
source(&quot;get_co2.R&quot;)</code></pre>
</div>
<div id="get-site-and-simulation-parameter-files" class="section level3">
<h3>4. Get site and simulation parameter files</h3>
<p>P-model simulations are done for each FLUXNET 2015 Tier 1 site separately, covering years for which data is available. After having prepared all the model forcing data by the steps described above, we now prepare the simulation and site parameter files. Here, we’re conducting one simulation per site.</p>
<p>Two types of paramter files have to be created:</p>
<ol style="list-style-type: decimal">
<li><strong>Site parameter files:</strong> Define the geographical location, elevation and soil parameters (or soil type) for each site.</li>
<li><strong>Simulation parameter files:</strong> Define the simulation start, and end years, number of spinup years, forcing data types, output variables, etc.</li>
</ol>
<p>Both are created by <code>prepare_paramfils.R</code> available from the repository <a href="https://bitbucket.org/labprentice/getin">getin</a>. In the header adjust manually:</p>
<pre class="r"><code>##--------------------------------------------------------------------
## MANUAL SETTINGS
##--------------------------------------------------------------------
myhome           = &quot;/alphadata01/bstocker/&quot;
simsuite         = &quot;fluxnet2015&quot;  
overwrite        = TRUE
##--------------------------------------------------------------------
## uncomment:
systr &lt;- &quot;&#39;&#39;&quot;    # for Mac
##--------------------------------------------------------------------</code></pre>
<p>Then run in R:</p>
<pre class="r"><code>setwd(&quot;your_chosen_home/getin&quot;)
source(&quot;prepare_paramfils.R&quot;)</code></pre>
</div>
<div id="get-compile-and-run-sofun" class="section level3">
<h3>5. Get, compile and run SOFUN</h3>
<p>The repository <a href="https://bitbucket.org/labprentice/sofun">sofun</a> contains all the model code (Fortran 90) that implements the P-model and additional levels of model integration (water balance only, closed C, closed C and N cycles, see also <a href="https://stineb.github.io">here</a>).</p>
<p>Clone the SOFUN repository and switch to branch pnmodel (XXX) using command line:</p>
<pre class="bash"><code>cd your_chosen_home
git clone https://bitbucket.org/labprentice/sofun
cd sofun
git checkout pnmodel</code></pre>
<p>Then, create soft links to input and parameter file directories by executing the Python script <code>linkdirs_sofun.py</code>. Before executing, specify the simulation suite inside this script manually:</p>
<pre class="py"><code>simsuite = &#39;fluxnet2015&#39;</code></pre>
<p>The following specification is required only for global simulations to link input fields (climate, fAPAR) to locations where data is read by SOFUN:</p>
<pre class="py"><code>dataroot = &#39;your_chosen_home/data/&#39;</code></pre>
<p>Then</p>
<pre class="bash"><code>python linkdirs_sofun.py</code></pre>
<div id="compile-sofun" class="section level4">
<h4>Compile SOFUN</h4>
<p>Running the set of simulations for the suite <code>fluxnet2015</code> is done be simply executing the Python script (after setting manually: <code>simsuite = 'fluxnet2015'</code>):</p>
<pre class="bash"><code>python submitjobs_sofun.py</code></pre>
<p>This executes the following basic statements that compile and run SOFUN:</p>
<pre class="bash"><code>make pmodel
echo simulation_name | ./runpmodel</code></pre>
<p>This setup compiles with the open-access GNU compiler for Fortran 90 gfortran and with the (non-open access) Portland Group Fortran Compiler.</p>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
